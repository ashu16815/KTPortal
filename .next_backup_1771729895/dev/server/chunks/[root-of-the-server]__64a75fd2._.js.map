{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/323905/Documents/VibeCoding/KTPortal/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client'\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined\n}\n\nexport const prisma =\n  globalForPrisma.prisma ??\n  new PrismaClient({\n    log: process.env.NODE_ENV === 'development' ? ['query', 'error', 'warn'] : ['error'],\n  })\n\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,kBAAkB;AAIjB,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,sMAAY,CAAC;IACf,KAAK,uCAAyC;QAAC;QAAS;QAAS;KAAO,GAAG;AAC7E;AAEF,wCAA2C,gBAAgB,MAAM,GAAG"}},
    {"offset": {"line": 65, "column": 0}, "map": {"version":3,"sources":["file:///Users/323905/Documents/VibeCoding/KTPortal/src/lib/auth.ts"],"sourcesContent":["import { cookies } from 'next/headers'\nimport type { SessionUser, UserRole } from '@/types'\n\nconst COOKIE_NAME = 'kt_stub_session'\n\nexport interface AuthProvider {\n  getSession(): Promise<SessionUser | null>\n  requireRole(allowedRoles: UserRole[]): Promise<SessionUser>\n}\n\n// Server-side: read cookie from next/headers\nexport async function getSession(): Promise<SessionUser | null> {\n  try {\n    const cookieStore = await cookies()\n    const cookie = cookieStore.get(COOKIE_NAME)\n    if (!cookie?.value) return null\n    const decoded = Buffer.from(cookie.value, 'base64').toString('utf-8')\n    return JSON.parse(decoded) as SessionUser\n  } catch {\n    return null\n  }\n}\n\nexport async function requireSession(): Promise<SessionUser> {\n  const session = await getSession()\n  if (!session) {\n    throw new Error('UNAUTHENTICATED')\n  }\n  return session\n}\n\nexport async function requireRole(allowedRoles: UserRole[]): Promise<SessionUser> {\n  const session = await requireSession()\n  if (!allowedRoles.includes(session.role as UserRole)) {\n    throw new Error('FORBIDDEN')\n  }\n  return session\n}\n\nexport function createSessionCookie(user: SessionUser): string {\n  return Buffer.from(JSON.stringify(user)).toString('base64')\n}\n\nexport const COOKIE_NAME_EXPORT = COOKIE_NAME\n"],"names":[],"mappings":";;;;;;;;;;;;AAAA;;AAGA,MAAM,cAAc;AAQb,eAAe;IACpB,IAAI;QACF,MAAM,cAAc,MAAM,IAAA,4IAAO;QACjC,MAAM,SAAS,YAAY,GAAG,CAAC;QAC/B,IAAI,CAAC,QAAQ,OAAO,OAAO;QAC3B,MAAM,UAAU,OAAO,IAAI,CAAC,OAAO,KAAK,EAAE,UAAU,QAAQ,CAAC;QAC7D,OAAO,KAAK,KAAK,CAAC;IACpB,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAEO,eAAe;IACpB,MAAM,UAAU,MAAM;IACtB,IAAI,CAAC,SAAS;QACZ,MAAM,IAAI,MAAM;IAClB;IACA,OAAO;AACT;AAEO,eAAe,YAAY,YAAwB;IACxD,MAAM,UAAU,MAAM;IACtB,IAAI,CAAC,aAAa,QAAQ,CAAC,QAAQ,IAAI,GAAe;QACpD,MAAM,IAAI,MAAM;IAClB;IACA,OAAO;AACT;AAEO,SAAS,oBAAoB,IAAiB;IACnD,OAAO,OAAO,IAAI,CAAC,KAAK,SAAS,CAAC,OAAO,QAAQ,CAAC;AACpD;AAEO,MAAM,qBAAqB"}},
    {"offset": {"line": 113, "column": 0}, "map": {"version":3,"sources":["file:///Users/323905/Documents/VibeCoding/KTPortal/src/lib/audit.ts"],"sourcesContent":["import { prisma } from './prisma'\n\nexport type AuditAction = 'CREATE' | 'UPDATE' | 'DELETE' | 'LOGIN'\nexport type AuditResource = 'tower' | 'track' | 'submission' | 'action' | 'user' | 'weights' | 'artefact' | 'decision' | 'auth'\n\nexport async function writeAudit(params: {\n  userId?: string\n  action: AuditAction\n  resource: AuditResource\n  resourceId?: string\n  details?: Record<string, unknown>\n}): Promise<void> {\n  try {\n    await prisma.auditLog.create({\n      data: {\n        userId: params.userId,\n        action: params.action,\n        resource: params.resource,\n        resourceId: params.resourceId,\n        details: params.details ? JSON.stringify(params.details) : undefined,\n      },\n    })\n  } catch (err) {\n    // Audit failures should not break the main operation\n    console.error('Audit write failed:', err)\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;;AAKO,eAAe,WAAW,MAMhC;IACC,IAAI;QACF,MAAM,gIAAM,CAAC,QAAQ,CAAC,MAAM,CAAC;YAC3B,MAAM;gBACJ,QAAQ,OAAO,MAAM;gBACrB,QAAQ,OAAO,MAAM;gBACrB,UAAU,OAAO,QAAQ;gBACzB,YAAY,OAAO,UAAU;gBAC7B,SAAS,OAAO,OAAO,GAAG,KAAK,SAAS,CAAC,OAAO,OAAO,IAAI;YAC7D;QACF;IACF,EAAE,OAAO,KAAK;QACZ,qDAAqD;QACrD,QAAQ,KAAK,CAAC,uBAAuB;IACvC;AACF"}},
    {"offset": {"line": 139, "column": 0}, "map": {"version":3,"sources":["file:///Users/323905/Documents/VibeCoding/KTPortal/src/app/api/admin/users/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { prisma } from '@/lib/prisma'\nimport { requireRole } from '@/lib/auth'\nimport { writeAudit } from '@/lib/audit'\n\nfunction handleAuthError(err: unknown) {\n  if (err instanceof Error && err.message === 'UNAUTHENTICATED') {\n    return NextResponse.json({ error: { code: 'UNAUTHENTICATED', message: 'Login required' } }, { status: 401 })\n  }\n  if (err instanceof Error && err.message === 'FORBIDDEN') {\n    return NextResponse.json({ error: { code: 'FORBIDDEN', message: 'Admin access required' } }, { status: 403 })\n  }\n  return null\n}\n\nexport async function GET() {\n  try {\n    await requireRole(['ADMIN'])\n    const users = await prisma.user.findMany({\n      orderBy: { name: 'asc' },\n      include: { tower: { select: { name: true } } },\n    })\n    return NextResponse.json({ data: users.map(u => ({ ...u, createdAt: u.createdAt.toISOString(), towerName: u.tower?.name })) })\n  } catch (err) {\n    const authResponse = handleAuthError(err)\n    if (authResponse) return authResponse\n    console.error('[admin/users]', err)\n    return NextResponse.json({ error: { code: 'INTERNAL', message: 'Failed' } }, { status: 500 })\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const session = await requireRole(['ADMIN'])\n    const body = await request.json()\n    const user = await prisma.user.create({\n      data: { email: body.email, name: body.name, role: body.role, org: body.org, towerId: body.towerId || undefined },\n    })\n    await writeAudit({ userId: session.id, action: 'CREATE', resource: 'user', resourceId: user.id })\n    return NextResponse.json({ data: { ...user, createdAt: user.createdAt.toISOString() } }, { status: 201 })\n  } catch (err) {\n    return handleAuthError(err) ?? NextResponse.json({ error: { code: 'INTERNAL', message: 'Failed to create user' } }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;AACA;;;;;AAEA,SAAS,gBAAgB,GAAY;IACnC,IAAI,eAAe,SAAS,IAAI,OAAO,KAAK,mBAAmB;QAC7D,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;gBAAE,MAAM;gBAAmB,SAAS;YAAiB;QAAE,GAAG;YAAE,QAAQ;QAAI;IAC5G;IACA,IAAI,eAAe,SAAS,IAAI,OAAO,KAAK,aAAa;QACvD,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;gBAAE,MAAM;gBAAa,SAAS;YAAwB;QAAE,GAAG;YAAE,QAAQ;QAAI;IAC7G;IACA,OAAO;AACT;AAEO,eAAe;IACpB,IAAI;QACF,MAAM,IAAA,mIAAW,EAAC;YAAC;SAAQ;QAC3B,MAAM,QAAQ,MAAM,gIAAM,CAAC,IAAI,CAAC,QAAQ,CAAC;YACvC,SAAS;gBAAE,MAAM;YAAM;YACvB,SAAS;gBAAE,OAAO;oBAAE,QAAQ;wBAAE,MAAM;oBAAK;gBAAE;YAAE;QAC/C;QACA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,MAAM,MAAM,GAAG,CAAC,CAAA,IAAK,CAAC;oBAAE,GAAG,CAAC;oBAAE,WAAW,EAAE,SAAS,CAAC,WAAW;oBAAI,WAAW,EAAE,KAAK,EAAE;gBAAK,CAAC;QAAG;IAC9H,EAAE,OAAO,KAAK;QACZ,MAAM,eAAe,gBAAgB;QACrC,IAAI,cAAc,OAAO;QACzB,QAAQ,KAAK,CAAC,iBAAiB;QAC/B,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;gBAAE,MAAM;gBAAY,SAAS;YAAS;QAAE,GAAG;YAAE,QAAQ;QAAI;IAC7F;AACF;AAEO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,UAAU,MAAM,IAAA,mIAAW,EAAC;YAAC;SAAQ;QAC3C,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,OAAO,MAAM,gIAAM,CAAC,IAAI,CAAC,MAAM,CAAC;YACpC,MAAM;gBAAE,OAAO,KAAK,KAAK;gBAAE,MAAM,KAAK,IAAI;gBAAE,MAAM,KAAK,IAAI;gBAAE,KAAK,KAAK,GAAG;gBAAE,SAAS,KAAK,OAAO,IAAI;YAAU;QACjH;QACA,MAAM,IAAA,mIAAU,EAAC;YAAE,QAAQ,QAAQ,EAAE;YAAE,QAAQ;YAAU,UAAU;YAAQ,YAAY,KAAK,EAAE;QAAC;QAC/F,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,MAAM;gBAAE,GAAG,IAAI;gBAAE,WAAW,KAAK,SAAS,CAAC,WAAW;YAAG;QAAE,GAAG;YAAE,QAAQ;QAAI;IACzG,EAAE,OAAO,KAAK;QACZ,OAAO,gBAAgB,QAAQ,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;gBAAE,MAAM;gBAAY,SAAS;YAAwB;QAAE,GAAG;YAAE,QAAQ;QAAI;IACpI;AACF"}}]
}