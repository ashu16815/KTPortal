{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/323905/Documents/VibeCoding/KTPortal/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client'\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined\n}\n\nexport const prisma =\n  globalForPrisma.prisma ??\n  new PrismaClient({\n    log: process.env.NODE_ENV === 'development' ? ['query', 'error', 'warn'] : ['error'],\n  })\n\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,kBAAkB;AAIjB,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,sMAAY,CAAC;IACf,KAAK,uCAAyC;QAAC;QAAS;QAAS;KAAO,GAAG;AAC7E;AAEF,wCAA2C,gBAAgB,MAAM,GAAG"}},
    {"offset": {"line": 65, "column": 0}, "map": {"version":3,"sources":["file:///Users/323905/Documents/VibeCoding/KTPortal/src/lib/utils.ts"],"sourcesContent":["import type { RAGStatus } from '@/types'\n\n// Normalise any date to the Friday of its ISO week\nexport function normaliseWeekEnding(date: Date | string): Date {\n  const d = typeof date === 'string' ? new Date(date) : new Date(date)\n  // 0=Sun,1=Mon,...,5=Fri,6=Sat\n  const day = d.getDay()\n  const diff = day <= 5 ? 5 - day : 6 // if Saturday, go forward 6 to next Friday\n  d.setDate(d.getDate() + diff)\n  d.setHours(0, 0, 0, 0)\n  return d\n}\n\nexport function formatScore(score: number): string {\n  return `${score}/100`\n}\n\nexport function ragColor(rag: RAGStatus): string {\n  switch (rag) {\n    case 'GREEN': return '#16a34a'\n    case 'AMBER': return '#d97706'\n    case 'RED': return '#dc2626'\n  }\n}\n\nexport function ragBg(rag: RAGStatus): string {\n  switch (rag) {\n    case 'GREEN': return 'bg-green-100 text-green-800'\n    case 'AMBER': return 'bg-amber-100 text-amber-800'\n    case 'RED': return 'bg-red-100 text-red-800'\n  }\n}\n\nexport function formatDate(date: string | Date): string {\n  const d = typeof date === 'string' ? new Date(date) : date\n  return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' })\n}\n\nexport function csvExport(headers: string[], rows: (string | number)[][]): string {\n  const escape = (v: string | number) => {\n    const s = String(v)\n    return s.includes(',') || s.includes('\"') || s.includes('\\n')\n      ? `\"${s.replace(/\"/g, '\"\"')}\"`\n      : s\n  }\n  const lines = [headers.map(escape).join(','), ...rows.map(r => r.map(escape).join(','))]\n  return lines.join('\\n')\n}\n\nexport function cn(...classes: (string | undefined | false | null)[]): string {\n  return classes.filter(Boolean).join(' ')\n}\n\nexport function safeParseJSON<T>(json: string | null | undefined, fallback: T): T {\n  if (!json) return fallback\n  try {\n    return JSON.parse(json) as T\n  } catch {\n    return fallback\n  }\n}\n\nexport function getCurrentWeekEnding(): Date {\n  return normaliseWeekEnding(new Date())\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;AAGO,SAAS,oBAAoB,IAAmB;IACrD,MAAM,IAAI,OAAO,SAAS,WAAW,IAAI,KAAK,QAAQ,IAAI,KAAK;IAC/D,8BAA8B;IAC9B,MAAM,MAAM,EAAE,MAAM;IACpB,MAAM,OAAO,OAAO,IAAI,IAAI,MAAM,EAAE,2CAA2C;;IAC/E,EAAE,OAAO,CAAC,EAAE,OAAO,KAAK;IACxB,EAAE,QAAQ,CAAC,GAAG,GAAG,GAAG;IACpB,OAAO;AACT;AAEO,SAAS,YAAY,KAAa;IACvC,OAAO,GAAG,MAAM,IAAI,CAAC;AACvB;AAEO,SAAS,SAAS,GAAc;IACrC,OAAQ;QACN,KAAK;YAAS,OAAO;QACrB,KAAK;YAAS,OAAO;QACrB,KAAK;YAAO,OAAO;IACrB;AACF;AAEO,SAAS,MAAM,GAAc;IAClC,OAAQ;QACN,KAAK;YAAS,OAAO;QACrB,KAAK;YAAS,OAAO;QACrB,KAAK;YAAO,OAAO;IACrB;AACF;AAEO,SAAS,WAAW,IAAmB;IAC5C,MAAM,IAAI,OAAO,SAAS,WAAW,IAAI,KAAK,QAAQ;IACtD,OAAO,EAAE,kBAAkB,CAAC,SAAS;QAAE,KAAK;QAAW,OAAO;QAAS,MAAM;IAAU;AACzF;AAEO,SAAS,UAAU,OAAiB,EAAE,IAA2B;IACtE,MAAM,SAAS,CAAC;QACd,MAAM,IAAI,OAAO;QACjB,OAAO,EAAE,QAAQ,CAAC,QAAQ,EAAE,QAAQ,CAAC,QAAQ,EAAE,QAAQ,CAAC,QACpD,CAAC,CAAC,EAAE,EAAE,OAAO,CAAC,MAAM,MAAM,CAAC,CAAC,GAC5B;IACN;IACA,MAAM,QAAQ;QAAC,QAAQ,GAAG,CAAC,QAAQ,IAAI,CAAC;WAAS,KAAK,GAAG,CAAC,CAAA,IAAK,EAAE,GAAG,CAAC,QAAQ,IAAI,CAAC;KAAM;IACxF,OAAO,MAAM,IAAI,CAAC;AACpB;AAEO,SAAS,GAAG,GAAG,OAA8C;IAClE,OAAO,QAAQ,MAAM,CAAC,SAAS,IAAI,CAAC;AACtC;AAEO,SAAS,cAAiB,IAA+B,EAAE,QAAW;IAC3E,IAAI,CAAC,MAAM,OAAO;IAClB,IAAI;QACF,OAAO,KAAK,KAAK,CAAC;IACpB,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAEO,SAAS;IACd,OAAO,oBAAoB,IAAI;AACjC"}},
    {"offset": {"line": 155, "column": 0}, "map": {"version":3,"sources":["file:///Users/323905/Documents/VibeCoding/KTPortal/src/app/api/dashboard/tower/%5Bid%5D/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { prisma } from '@/lib/prisma'\nimport { normaliseWeekEnding, safeParseJSON } from '@/lib/utils'\n\nexport async function GET(request: NextRequest, { params }: { params: Promise<{ id: string }> }) {\n  try {\n    const { id } = await params\n    const { searchParams } = new URL(request.url)\n    const weekEndingStr = searchParams.get('weekEnding')\n    const weekEnding = weekEndingStr ? normaliseWeekEnding(weekEndingStr) : normaliseWeekEnding(new Date())\n\n    const tower = await prisma.tower.findUnique({ where: { id } })\n    if (!tower) return NextResponse.json({ error: { code: 'NOT_FOUND', message: 'Tower not found' } }, { status: 404 })\n\n    const [tracks, latestTwg, latestTcs, trend, actions, artefacts, pendingDecisions] = await Promise.all([\n      prisma.track.findMany({ where: { towerId: id }, orderBy: { name: 'asc' } }),\n      prisma.weeklySubmission.findUnique({ where: { towerId_weekEnding_org: { towerId: id, weekEnding, org: 'TWG' } } }),\n      prisma.weeklySubmission.findUnique({ where: { towerId_weekEnding_org: { towerId: id, weekEnding, org: 'TCS' } } }),\n      prisma.healthScoreHistory.findMany({ where: { towerId: id }, orderBy: { weekEnding: 'asc' }, take: 8 }),\n      prisma.action.findMany({ where: { towerId: id }, include: { owner: { select: { name: true } }, tower: { select: { name: true } } }, orderBy: { dueDate: 'asc' } }),\n      prisma.artefact.findMany({ where: { towerId: id }, orderBy: { type: 'asc' } }),\n      prisma.decision.findMany({ where: { towerId: id, status: 'PENDING' }, orderBy: { createdAt: 'desc' } }),\n    ])\n\n    const mapSub = (s: typeof latestTwg) => s ? {\n      ...s,\n      weekEnding: s.weekEnding.toISOString(),\n      createdAt: s.createdAt.toISOString(),\n      updatedAt: s.updatedAt.toISOString(),\n      risks: safeParseJSON<string[]>(s.risks, []),\n      blockers: safeParseJSON<string[]>(s.blockers, []),\n      evidenceLinks: safeParseJSON<string[]>(s.evidenceLinks, []),\n    } : undefined\n\n    return NextResponse.json({\n      data: {\n        tower: { id: tower.id, name: tower.name, description: tower.description, createdAt: tower.createdAt.toISOString() },\n        tracks,\n        latestTwg: mapSub(latestTwg),\n        latestTcs: mapSub(latestTcs),\n        trend: trend.map(t => ({ ...t, weekEnding: t.weekEnding.toISOString(), createdAt: t.createdAt.toISOString(), updatedAt: t.updatedAt.toISOString() })),\n        actions: actions.map(a => ({\n          ...a,\n          ownerName: a.owner.name,\n          towerName: a.tower.name,\n          dueDate: a.dueDate?.toISOString(),\n          resolvedAt: a.resolvedAt?.toISOString(),\n          createdAt: a.createdAt.toISOString(),\n          updatedAt: a.updatedAt.toISOString(),\n          owner: undefined,\n          tower: undefined,\n        })),\n        artefacts: artefacts.map(a => ({ ...a, uploadedAt: a.uploadedAt?.toISOString(), createdAt: a.createdAt.toISOString() })),\n        pendingDecisions: pendingDecisions.map(d => ({ ...d, decidedAt: d.decidedAt?.toISOString(), createdAt: d.createdAt.toISOString(), updatedAt: d.updatedAt.toISOString() })),\n        weekEnding: weekEnding.toISOString(),\n      }\n    })\n  } catch (err) {\n    console.error(err)\n    return NextResponse.json({ error: { code: 'INTERNAL', message: 'Failed to load tower dashboard' } }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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"}}]
}