{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/323905/Documents/VibeCoding/KTPortal/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client'\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined\n}\n\nexport const prisma =\n  globalForPrisma.prisma ??\n  new PrismaClient({\n    log: process.env.NODE_ENV === 'development' ? ['query', 'error', 'warn'] : ['error'],\n  })\n\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,kBAAkB;AAIjB,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,sMAAY,CAAC;IACf,KAAK,uCAAyC;QAAC;QAAS;QAAS;KAAO,GAAG;AAC7E;AAEF,wCAA2C,gBAAgB,MAAM,GAAG"}},
    {"offset": {"line": 65, "column": 0}, "map": {"version":3,"sources":["file:///Users/323905/Documents/VibeCoding/KTPortal/src/lib/utils.ts"],"sourcesContent":["import type { RAGStatus } from '@/types'\n\n// Normalise any date to the Friday of its ISO week\nexport function normaliseWeekEnding(date: Date | string): Date {\n  const d = typeof date === 'string' ? new Date(date) : new Date(date)\n  // 0=Sun,1=Mon,...,5=Fri,6=Sat\n  const day = d.getDay()\n  const diff = day <= 5 ? 5 - day : 6 // if Saturday, go forward 6 to next Friday\n  d.setDate(d.getDate() + diff)\n  d.setHours(0, 0, 0, 0)\n  return d\n}\n\nexport function formatScore(score: number): string {\n  return `${score}/100`\n}\n\nexport function ragColor(rag: RAGStatus): string {\n  switch (rag) {\n    case 'GREEN': return '#16a34a'\n    case 'AMBER': return '#d97706'\n    case 'RED': return '#dc2626'\n  }\n}\n\nexport function ragBg(rag: RAGStatus): string {\n  switch (rag) {\n    case 'GREEN': return 'bg-green-100 text-green-800'\n    case 'AMBER': return 'bg-amber-100 text-amber-800'\n    case 'RED': return 'bg-red-100 text-red-800'\n  }\n}\n\nexport function formatDate(date: string | Date): string {\n  const d = typeof date === 'string' ? new Date(date) : date\n  return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' })\n}\n\nexport function csvExport(headers: string[], rows: (string | number)[][]): string {\n  const escape = (v: string | number) => {\n    const s = String(v)\n    return s.includes(',') || s.includes('\"') || s.includes('\\n')\n      ? `\"${s.replace(/\"/g, '\"\"')}\"`\n      : s\n  }\n  const lines = [headers.map(escape).join(','), ...rows.map(r => r.map(escape).join(','))]\n  return lines.join('\\n')\n}\n\nexport function cn(...classes: (string | undefined | false | null)[]): string {\n  return classes.filter(Boolean).join(' ')\n}\n\nexport function safeParseJSON<T>(json: string | null | undefined, fallback: T): T {\n  if (!json) return fallback\n  try {\n    return JSON.parse(json) as T\n  } catch {\n    return fallback\n  }\n}\n\nexport function getCurrentWeekEnding(): Date {\n  return normaliseWeekEnding(new Date())\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;AAGO,SAAS,oBAAoB,IAAmB;IACrD,MAAM,IAAI,OAAO,SAAS,WAAW,IAAI,KAAK,QAAQ,IAAI,KAAK;IAC/D,8BAA8B;IAC9B,MAAM,MAAM,EAAE,MAAM;IACpB,MAAM,OAAO,OAAO,IAAI,IAAI,MAAM,EAAE,2CAA2C;;IAC/E,EAAE,OAAO,CAAC,EAAE,OAAO,KAAK;IACxB,EAAE,QAAQ,CAAC,GAAG,GAAG,GAAG;IACpB,OAAO;AACT;AAEO,SAAS,YAAY,KAAa;IACvC,OAAO,GAAG,MAAM,IAAI,CAAC;AACvB;AAEO,SAAS,SAAS,GAAc;IACrC,OAAQ;QACN,KAAK;YAAS,OAAO;QACrB,KAAK;YAAS,OAAO;QACrB,KAAK;YAAO,OAAO;IACrB;AACF;AAEO,SAAS,MAAM,GAAc;IAClC,OAAQ;QACN,KAAK;YAAS,OAAO;QACrB,KAAK;YAAS,OAAO;QACrB,KAAK;YAAO,OAAO;IACrB;AACF;AAEO,SAAS,WAAW,IAAmB;IAC5C,MAAM,IAAI,OAAO,SAAS,WAAW,IAAI,KAAK,QAAQ;IACtD,OAAO,EAAE,kBAAkB,CAAC,SAAS;QAAE,KAAK;QAAW,OAAO;QAAS,MAAM;IAAU;AACzF;AAEO,SAAS,UAAU,OAAiB,EAAE,IAA2B;IACtE,MAAM,SAAS,CAAC;QACd,MAAM,IAAI,OAAO;QACjB,OAAO,EAAE,QAAQ,CAAC,QAAQ,EAAE,QAAQ,CAAC,QAAQ,EAAE,QAAQ,CAAC,QACpD,CAAC,CAAC,EAAE,EAAE,OAAO,CAAC,MAAM,MAAM,CAAC,CAAC,GAC5B;IACN;IACA,MAAM,QAAQ;QAAC,QAAQ,GAAG,CAAC,QAAQ,IAAI,CAAC;WAAS,KAAK,GAAG,CAAC,CAAA,IAAK,EAAE,GAAG,CAAC,QAAQ,IAAI,CAAC;KAAM;IACxF,OAAO,MAAM,IAAI,CAAC;AACpB;AAEO,SAAS,GAAG,GAAG,OAA8C;IAClE,OAAO,QAAQ,MAAM,CAAC,SAAS,IAAI,CAAC;AACtC;AAEO,SAAS,cAAiB,IAA+B,EAAE,QAAW;IAC3E,IAAI,CAAC,MAAM,OAAO;IAClB,IAAI;QACF,OAAO,KAAK,KAAK,CAAC;IACpB,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAEO,SAAS;IACd,OAAO,oBAAoB,IAAI;AACjC"}},
    {"offset": {"line": 155, "column": 0}, "map": {"version":3,"sources":["file:///Users/323905/Documents/VibeCoding/KTPortal/src/lib/scoring.ts"],"sourcesContent":["import type { ScoreInput, ScoreResult, RAGStatus, ScoringWeightsDTO } from '@/types'\n\nexport const DEFAULT_WEIGHTS: Omit<ScoringWeightsDTO, 'id'> = {\n  progressWeight: 0.25,\n  coverageWeight: 0.25,\n  confidenceWeight: 0.20,\n  operationalWeight: 0.15,\n  qualityWeight: 0.15,\n  greenThreshold: 75,\n  amberThreshold: 50,\n  varianceThreshold: 20,\n}\n\nexport function calculateScore(input: ScoreInput, weights: Omit<ScoringWeightsDTO, 'id'> = DEFAULT_WEIGHTS): ScoreResult {\n  const raw =\n    input.progressScore * weights.progressWeight +\n    input.coverageScore * weights.coverageWeight +\n    input.confidenceScore * weights.confidenceWeight +\n    input.operationalScore * weights.operationalWeight +\n    input.qualityScore * weights.qualityWeight\n\n  const totalScore = Math.min(100, Math.max(0, Math.round(raw)))\n  const ragStatus = determineRAG(totalScore, input.hasActiveBlocker, weights)\n\n  return { totalScore, ragStatus }\n}\n\nexport function determineRAG(\n  score: number,\n  hasActiveBlocker: boolean,\n  weights: Omit<ScoringWeightsDTO, 'id'> = DEFAULT_WEIGHTS\n): RAGStatus {\n  if (hasActiveBlocker) return 'RED'\n  if (score >= weights.greenThreshold) return 'GREEN'\n  if (score >= weights.amberThreshold) return 'AMBER'\n  return 'RED'\n}\n\nexport function calculateVariance(twgTotal: number, tcsTotal: number): number {\n  return Math.abs(twgTotal - tcsTotal)\n}\n\nexport function isVarianceFlagged(variance: number, threshold: number = DEFAULT_WEIGHTS.varianceThreshold): boolean {\n  return variance > threshold\n}\n"],"names":[],"mappings":";;;;;;;;;;;;AAEO,MAAM,kBAAiD;IAC5D,gBAAgB;IAChB,gBAAgB;IAChB,kBAAkB;IAClB,mBAAmB;IACnB,eAAe;IACf,gBAAgB;IAChB,gBAAgB;IAChB,mBAAmB;AACrB;AAEO,SAAS,eAAe,KAAiB,EAAE,UAAyC,eAAe;IACxG,MAAM,MACJ,MAAM,aAAa,GAAG,QAAQ,cAAc,GAC5C,MAAM,aAAa,GAAG,QAAQ,cAAc,GAC5C,MAAM,eAAe,GAAG,QAAQ,gBAAgB,GAChD,MAAM,gBAAgB,GAAG,QAAQ,iBAAiB,GAClD,MAAM,YAAY,GAAG,QAAQ,aAAa;IAE5C,MAAM,aAAa,KAAK,GAAG,CAAC,KAAK,KAAK,GAAG,CAAC,GAAG,KAAK,KAAK,CAAC;IACxD,MAAM,YAAY,aAAa,YAAY,MAAM,gBAAgB,EAAE;IAEnE,OAAO;QAAE;QAAY;IAAU;AACjC;AAEO,SAAS,aACd,KAAa,EACb,gBAAyB,EACzB,UAAyC,eAAe;IAExD,IAAI,kBAAkB,OAAO;IAC7B,IAAI,SAAS,QAAQ,cAAc,EAAE,OAAO;IAC5C,IAAI,SAAS,QAAQ,cAAc,EAAE,OAAO;IAC5C,OAAO;AACT;AAEO,SAAS,kBAAkB,QAAgB,EAAE,QAAgB;IAClE,OAAO,KAAK,GAAG,CAAC,WAAW;AAC7B;AAEO,SAAS,kBAAkB,QAAgB,EAAE,YAAoB,gBAAgB,iBAAiB;IACvG,OAAO,WAAW;AACpB"}},
    {"offset": {"line": 202, "column": 0}, "map": {"version":3,"sources":["file:///Users/323905/Documents/VibeCoding/KTPortal/src/app/api/dashboard/executive/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server'\nimport { prisma } from '@/lib/prisma'\nimport { normaliseWeekEnding } from '@/lib/utils'\nimport { calculateVariance, isVarianceFlagged } from '@/lib/scoring'\n\nexport async function GET() {\n  try {\n    const weekEnding = normaliseWeekEnding(new Date())\n\n    const towers = await prisma.tower.findMany({\n      orderBy: { name: 'asc' },\n      include: {\n        artefacts: true,\n        _count: { select: { actions: { where: { status: { in: ['OPEN', 'IN_PROGRESS', 'OVERDUE'] } } } } },\n      },\n    })\n\n    const weightsRow = await prisma.scoringWeights.findFirst()\n    const varianceThreshold = weightsRow?.varianceThreshold ?? 20\n\n    const pendingDecisions = await prisma.decision.count({ where: { status: 'PENDING' } })\n\n    const towerSummaries = await Promise.all(towers.map(async tower => {\n      const [twgScore, tcsScore, trend, overdueActions] = await Promise.all([\n        prisma.healthScoreHistory.findUnique({\n          where: { towerId_weekEnding_org: { towerId: tower.id, weekEnding, org: 'TWG' } },\n        }),\n        prisma.healthScoreHistory.findUnique({\n          where: { towerId_weekEnding_org: { towerId: tower.id, weekEnding, org: 'TCS' } },\n        }),\n        prisma.healthScoreHistory.findMany({\n          where: { towerId: tower.id },\n          orderBy: { weekEnding: 'asc' },\n          take: 8,\n        }),\n        prisma.action.count({ where: { towerId: tower.id, status: 'OVERDUE' } }),\n      ])\n\n      const variance = twgScore && tcsScore ? calculateVariance(twgScore.totalScore, tcsScore.totalScore) : undefined\n      const varianceFlagged = variance !== undefined ? isVarianceFlagged(variance, varianceThreshold) : false\n\n      const totalArtefacts = tower.artefacts.length\n      const uploadedArtefacts = tower.artefacts.filter(a => a.uploaded).length\n      const artefactCoverage = totalArtefacts > 0 ? uploadedArtefacts / totalArtefacts : 0\n\n      const mapScore = (s: typeof twgScore) => s ? {\n        ...s,\n        weekEnding: s.weekEnding.toISOString(),\n        createdAt: s.createdAt.toISOString(),\n        updatedAt: s.updatedAt.toISOString(),\n      } : undefined\n\n      return {\n        tower: { id: tower.id, name: tower.name, description: tower.description, createdAt: tower.createdAt.toISOString() },\n        twgScore: mapScore(twgScore),\n        tcsScore: mapScore(tcsScore),\n        variance,\n        varianceFlagged,\n        latestWeekEnding: weekEnding.toISOString(),\n        trend: trend.map(t => ({ ...t, weekEnding: t.weekEnding.toISOString(), createdAt: t.createdAt.toISOString(), updatedAt: t.updatedAt.toISOString() })),\n        overdueActions,\n        pendingDecisions,\n        artefactCoverage,\n      }\n    }))\n\n    const totalSubmissions = await prisma.weeklySubmission.count()\n\n    return NextResponse.json({\n      data: {\n        towers: towerSummaries,\n        totalSubmissions,\n        weekEnding: weekEnding.toISOString(),\n        generatedAt: new Date().toISOString(),\n      }\n    })\n  } catch (err) {\n    console.error(err)\n    return NextResponse.json({ error: { code: 'INTERNAL', message: 'Failed to load executive dashboard' } }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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"}}]
}