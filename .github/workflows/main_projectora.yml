# Build and deploy Next.js (standalone) to Azure Web App - projectora
# Required GitHub Secrets:
#   AZUREAPPSERVICE_PUBLISHPROFILE_E7E4C9BDB6054DF691355ADA420FDC35  — download from Azure portal > App Service > Deployment Center > Manage publish profile
#
# Required Azure App Service Configuration (set in portal > Configuration > Application settings):
#   DATABASE_URL     sqlserver://SERVER.database.windows.net:1433;database=DB;user=USER;password=PASS;encrypt=true
#   NEXTAUTH_SECRET  <random-strong-secret>
#   HOSTNAME         0.0.0.0
#   PORT             8080
#   AZURE_OPENAI_KEY          (optional — for AI summaries)
#   AZURE_OPENAI_ENDPOINT     (optional)
#   AZURE_OPENAI_DEPLOYMENT   gpt-4o
#
# Azure App Service > Configuration > General settings > Startup Command:
#   node /home/site/wwwroot/server.js

name: Build and deploy Node.js app to Azure Web App - projectora

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      NEXT_TELEMETRY_DISABLED: "1"
      NEXT_PUBLIC_APP_NAME: "KT Portal"
      # DATABASE_URL is not needed at build time — Prisma generate only reads schema.prisma
      DATABASE_URL: "sqlserver://placeholder:1433;database=ktportal;user=placeholder;password=placeholder;encrypt=false"
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js version
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma client
        run: npx prisma generate

      - name: Build Next.js (standalone output)
        run: npm run build --if-present

      - name: Verify Next.js build output
        run: |
          test -f .next/BUILD_ID
          test -f .next/standalone/server.js

      - name: Prepare standalone deployment package
        run: |
          # Copy static assets into the standalone folder
          cp -r .next/static .next/standalone/.next/static
          cp -r public .next/standalone/public

      - name: Upload artifact for deployment job
        uses: actions/upload-artifact@v4
        with:
          name: node-app
          path: .next/standalone
          include-hidden-files: true

  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: 'Production'
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}

    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: node-app

      - name: Verify deploy artifact
        run: test -f server.js

      - name: Deploy to Azure Web App
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'projectora'
          slot-name: 'Production'
          package: .
          publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_E7E4C9BDB6054DF691355ADA420FDC35 }}
